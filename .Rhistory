residualPlots( m3)
marginalModelPlots(m3, id=list(n=5, labels=rownames(df)))
length(df[,1])
length(df[-infres,1])
llev <- which( hatvalues(m2) > 2*(length(coef(m2))/nrow(df)));llev
llev <- which( hatvalues(m2) > 2*(length(coef(m2))/nrow(df)));llev
m6 <- lm(log(charges) ~  age +I(age^2) + bmi + I(children+0.5) + sex + smoker + region, data = df[-infres,])
summary(m6)
# Threshold Chatterjee-Hadi
thChH <- 4/ (nrow(df) - length(coef(m2)));thChH
par(mfrow=c(1,1))
influencePlot(m2)
#Actual influent data Cook´s distance: outliers in cook´s distance
Boxplot(cooks.distance(m2))
abline(h=thChH,col="red",lwd=3)
resout <- which( cooks.distance(m2) > thChH);resout
length(resout)
infres <- as.integer(c(llev,resout))
infres <- sort(infres[!duplicated(infres)]); infres
length(infres)
# BORRAR?
m3 <- lm(log(charges) ~  age + I(age^2) + bmi + I(children+0.5) , data = df[-infres,])
summary(m3) # R2 = 0.4556
# Load Required Packages: to be increased over the course
requiredPackages <- c("missMDA","effects","FactoMineR","car","factoextra","RColorBrewer","ggplot2","dplyr","ggmap","ggthemes","knitr","chemometrics","rpart","ROCR","corrr","readxl","RColorBrewer","psych","corrplot","plotly","xlsx","reshape2","scales","stargazer","kableExtra","lmtest","MASS","effects","car")
package.check <- lapply(requiredPackages, FUN = function(x) {
if (!require(x, character.only = TRUE)) {
install.packages(x, dependencies = TRUE)
library(x, character.only = TRUE)
}
})
df <- read.csv("insurance.csv")
summary(df)
#View(df)
df[duplicated(df), ]
nrow(df)
df <- df[!duplicated(df), ]
nrow(df)
lapply(df, class)
categ_cols <- c( 'sex', 'smoker', 'region')
df[categ_cols] = lapply(df[categ_cols], FUN = as.factor)
lapply(df, class)
par(mfrow=c(1,2))
Boxplot(df[,c(1,3,4)])
#Age no outliers
#Children no outliers
Boxplot(df$bmi)
Boxplot(df$charges)
#bmi and charges seem to have outliers
#Checking outliers for bmi
ss<-summary(df$bmi);ss
# Upper/lower severe threshold
utso2<-ss[5]+3*(ss[5]-ss[2]);utso2
utsi2<-ss[2]-3*(ss[5]-ss[2]);utsi2
# Upper/lower mild threshold
utmo2<-ss[5]+1.5*(ss[5]-ss[2]);utmo2
utmi2<-ss[2]-1.5*(ss[5]-ss[2]);utmi2
Boxplot(df$bmi,id=list(n=Inf,labels=row.names(df)))
Boxplot(df$bmi)
abline(h=utso2,col="red",lwd=3)
abline(h=utsi2,col="red",lwd=3)
abline(h=utmo2,col="green",lwd=3)
abline(h=utmi2,col="green",lwd=3)
lls.bmi<-which((df$bmi>utso2)|(df$bmi<utsi2));lls.bmi
df[lls.bmi,]
llm.bmi<-which((df$bmi>utmo2)|(df$bmi<utmi2));llm.bmi
df[llm.bmi,]
par(mfrow=c(1,1))
#Checking outliers for charges
ss<-summary(df$charges);ss
# Upper/lower severe threshold
utso2<-ss[5]+3*(ss[5]-ss[2]);utso2
utsi2<-ss[2]-3*(ss[5]-ss[2]);utsi2
# Upper/lower mild threshold
utmo2<-ss[5]+1.5*(ss[5]-ss[2]);utmo2
utmi2<-ss[2]-1.5*(ss[5]-ss[2]);utmi2
Boxplot(df$charges,id=list(n=Inf,labels=row.names(df)))
Boxplot(df$charges)
abline(h=utso2,col="red",lwd=3)
abline(h=utsi2,col="red",lwd=3)
abline(h=utmo2,col="green",lwd=3)
abline(h=utmi2,col="green",lwd=3)
lls<-which((df$charges>utso2)|(df$charges<utsi2));lls
df[lls,]
llm<-which((df$charges>utmo2)|(df$charges<utmi2));llm
df[llm,]
par(mfrow=c(1,1))
#Setting severe outliers from charges as NA
df[lls,"charges"]<-NA
summary(df$charges)
mis_col = colSums(is.na(df))
mis_col
#Only charges has missing data (outliers)
#They can't be imputed because it is the target variable, so they are deleted
md<-which(is.na(df$charges));md
df <- df[-md,]
nrow(df)
library(chemometrics)
res.mout <- Moutlier( df[ , c(1,3,4,7)], quantile = 0.999 )
par(mfrow=c(1,1))
plot( res.mout$md, res.mout$rd )
abline( h=res.mout$cutoff, lwd=2, col="red")
abline( v=res.mout$cutoff, lwd=2, col="red")
llmout <- which( ( res.mout$md > res.mout$cutoff ) & (res.mout$rd > res.mout$cutoff) );llmout
df[llmout,]
res.mout$md[llmout]
#Since there is only one multivariate outlier, we delete it
df <- df[-llmout,]
summary(df)
summary(df)
str(df)
#Normal Check
hist(df$charges, freq=F, main="charges")
curve(dnorm(x,mean(x),sd(x)),lwd=2,add=T,col="red")
shapiro.test(df$charges)
#Log normal check
hist(log(df$charges), freq=F, main="charges")
curve(dnorm(x,mean(x),sd(x)),lwd=2,add=T,col="red")
shapiro.test(log(df$charges))
# autocorrelation
acf(df$charges)
# Durbin-Watson Test for serial correlation
dwtest(df$charge ~ 1)
cor(df[c(7,1,3,4)])
pairs.panels(df[c(7,1,3,4)])
plot(df[c(7,1,3,4)])
#First we check if there is any likely relation with any variable
par( mfrow = c(2,2))
plot(df$charges ~ df$age)
plot(df$charges ~ df$bmi)
plot(df$charges ~ df$children)
par( mfrow = c(1,1))
#It seems that with age there might be and slight cuadratic relation
m0a1 <- lm(charges ~ age, data = df)
summary(m0a1)
plot(df$charges ~ df$age)
lines(df$age, fitted(m0a1), lty = 2,col="red")
m0a2 <- lm(charges ~ age+ I(age^2), data = df)
summary(m0a2)
lines(df$age, fitted(m0a2), lty = 2,col="darkgreen")
m0a3 <- lm(charges ~ I(age^2), data = df)
summary(m0a3)
lines(df$age, fitted(m0a3), lty = 2,col="pink")
AIC(m0a1,m0a2,m0a3)
#Seems that using a polinomic aproach in age it would work better
#Now we check with bmi
m0b <- lm(charges ~ bmi, data = df)
summary(m0b)
plot(df$charges ~ df$bmi)
lines(df$bmi, fitted(m0b), lty = 2,col="red")
#there seems to not be a pattern
#Now we check with children
m0c <- lm(charges ~ children, data = df)
summary(m0c)
plot(df$charges ~ df$children)
lines(df$children, fitted(m0c), lty = 2,col="red")
#there seems to not be a pattern
#Now we try all the numeric values
m0 <- lm(charges ~ age + bmi + children , data = df)
summary(m0)
#The intercept is difficult to interpret because it is impossible to have 0's for all values
par( mfrow = c(2,2))
plot(m0, id.n = 0)
par( mfrow = c(1,1))
#Variance inflation factor
vif(m0)
boxcox( charges ~ age + bmi + children , data=df) #lambda = 0
boxTidwell( charges ~ age + bmi + I(children+0.5) , data=df) #lambda age = 1.8
boxTidwell( log(charges) ~ age + bmi + I(children+0.5) , data=df) #lambda age = 0.5
# First we will try the polinomic convertion with age
m1 <- lm(log(charges) ~ age + I(age^2) + bmi + I(children+0.5) , data = df)
summary(m1) # R2 = 0.3081
m2 <- lm(log(charges) ~  I(age^2) + bmi + I(children+0.5) , data = df)
summary(m2) #R2 = 0.2946
anova(m2,m1) # both models are not equivalent
AIC(m1,m2) #m1 has the best AIC (3048.388)
summary(m1)$r.squared
#So until now we keep m1, that has R2 =  0.3081237
length(coef(m1))
#Potentially influent data
llev <- which( hatvalues(m1) > 2*(length(coef(m1))/nrow(df)));llev
m2 <- lm(log(charges) ~  age + I(age^2) + bmi + I(children+0.5) , data = df[-llev,])
summary(m2) # R2 = 0.3047
residualPlots(m2)
marginalModelPlots(m2, id=list(n=5, labels=rownames(df)))
# Threshold Chatterjee-Hadi
thChH <- 4/ (nrow(df) - length(coef(m2)));thChH
par(mfrow=c(1,1))
influencePlot(m2)
length(coef(m2)
length(coef(m2)
length(coef(m2))
par(mfrow=c(1,1))
influencePlot(m2)
cooks.distance(m2)
#Actual influent data Cook´s distance: outliers in cook´s distance
Boxplot(cooks.distance(m2))
abline(h=thChH,col="red",lwd=3)
resout <- which( cooks.distance(m2) > thChH);resout
length(resout)
infres <- as.integer(c(llev,resout))
infres <- sort(infres[!duplicated(infres)]); infres
length(infres)
# BORRAR?
m3 <- lm(log(charges) ~  age + I(age^2) + bmi + I(children+0.5) , data = df[-infres,])
summary(m3) # R2 = 0.4556
infres <- as.integer(c(llev,resout))
infres <- sort(infres[!duplicated(infres)]); infres
length(infres)
# BORRAR?
m3 <- lm(log(charges) ~  age + I(age^2) + bmi + I(children+0.5) , data = df[-infres,])
summary(m3) # R2 = 0.4556
infres <- as.integer(c(llev,resout))
infres <- sort(infres[!duplicated(infres)]); infres
length(infres)
# Load Required Packages: to be increased over the course
requiredPackages <- c("missMDA","effects","FactoMineR","car","factoextra","RColorBrewer","ggplot2","dplyr","ggmap","ggthemes","knitr","chemometrics","rpart","ROCR","corrr","readxl","RColorBrewer","psych","corrplot","plotly","xlsx","reshape2","scales","stargazer","kableExtra","lmtest","MASS","effects","car")
package.check <- lapply(requiredPackages, FUN = function(x) {
if (!require(x, character.only = TRUE)) {
install.packages(x, dependencies = TRUE)
library(x, character.only = TRUE)
}
})
df <- read.csv("insurance.csv")
summary(df)
#View(df)
df[duplicated(df), ]
nrow(df)
df <- df[!duplicated(df), ]
nrow(df)
# Chunk 1
# Load Required Packages: to be increased over the course
requiredPackages <- c("missMDA","effects","FactoMineR","car","factoextra","RColorBrewer","ggplot2","dplyr","ggmap","ggthemes","knitr","chemometrics","rpart","ROCR","corrr","readxl","RColorBrewer","psych","corrplot","plotly","xlsx","reshape2","scales","stargazer","kableExtra","lmtest","MASS","effects","car")
package.check <- lapply(requiredPackages, FUN = function(x) {
if (!require(x, character.only = TRUE)) {
install.packages(x, dependencies = TRUE)
library(x, character.only = TRUE)
}
})
# Chunk 2
df <- read.csv("insurance.csv")
summary(df)
#View(df)
# Chunk 3
df[duplicated(df), ]
nrow(df)
df <- df[!duplicated(df), ]
nrow(df)
# Chunk 4
# Chunk 5
lapply(df, class)
categ_cols <- c( 'sex', 'smoker', 'region')
df[categ_cols] = lapply(df[categ_cols], FUN = as.factor)
lapply(df, class)
# Chunk 6
par(mfrow=c(1,2))
Boxplot(df[,c(1,3,4)])
#Age no outliers
#Children no outliers
Boxplot(df$bmi)
Boxplot(df$charges)
#bmi and charges seem to have outliers
#Checking outliers for bmi
ss<-summary(df$bmi);ss
# Upper/lower severe threshold
utso2<-ss[5]+3*(ss[5]-ss[2]);utso2
utsi2<-ss[2]-3*(ss[5]-ss[2]);utsi2
# Upper/lower mild threshold
utmo2<-ss[5]+1.5*(ss[5]-ss[2]);utmo2
utmi2<-ss[2]-1.5*(ss[5]-ss[2]);utmi2
Boxplot(df$bmi,id=list(n=Inf,labels=row.names(df)))
Boxplot(df$bmi)
abline(h=utso2,col="red",lwd=3)
abline(h=utsi2,col="red",lwd=3)
abline(h=utmo2,col="green",lwd=3)
abline(h=utmi2,col="green",lwd=3)
lls.bmi<-which((df$bmi>utso2)|(df$bmi<utsi2));lls.bmi
df[lls.bmi,]
llm.bmi<-which((df$bmi>utmo2)|(df$bmi<utmi2));llm.bmi
df[llm.bmi,]
par(mfrow=c(1,1))
#Checking outliers for charges
ss<-summary(df$charges);ss
# Upper/lower severe threshold
utso2<-ss[5]+3*(ss[5]-ss[2]);utso2
utsi2<-ss[2]-3*(ss[5]-ss[2]);utsi2
# Upper/lower mild threshold
utmo2<-ss[5]+1.5*(ss[5]-ss[2]);utmo2
utmi2<-ss[2]-1.5*(ss[5]-ss[2]);utmi2
Boxplot(df$charges,id=list(n=Inf,labels=row.names(df)))
Boxplot(df$charges)
abline(h=utso2,col="red",lwd=3)
abline(h=utsi2,col="red",lwd=3)
abline(h=utmo2,col="green",lwd=3)
abline(h=utmi2,col="green",lwd=3)
lls<-which((df$charges>utso2)|(df$charges<utsi2));lls
df[lls,]
llm<-which((df$charges>utmo2)|(df$charges<utmi2));llm
df[llm,]
par(mfrow=c(1,1))
#Setting severe outliers from charges as NA
df[lls,"charges"]<-NA
summary(df$charges)
# Chunk 7
mis_col = colSums(is.na(df))
mis_col
#Only charges has missing data (outliers)
#They can't be imputed because it is the target variable, so they are deleted
md<-which(is.na(df$charges));md
df <- df[-md,]
nrow(df)
# Chunk 8
library(chemometrics)
res.mout <- Moutlier( df[ , c(1,3,4,7)], quantile = 0.999 )
par(mfrow=c(1,1))
plot( res.mout$md, res.mout$rd )
abline( h=res.mout$cutoff, lwd=2, col="red")
abline( v=res.mout$cutoff, lwd=2, col="red")
llmout <- which( ( res.mout$md > res.mout$cutoff ) & (res.mout$rd > res.mout$cutoff) );llmout
df[llmout,]
res.mout$md[llmout]
#Since there is only one multivariate outlier, we delete it
df <- df[-llmout,]
# Chunk 9
summary(df)
# Chunk 10
summary(df)
str(df)
# Chunk 11
#Normal Check
hist(df$charges, freq=F, main="charges")
curve(dnorm(x,mean(x),sd(x)),lwd=2,add=T,col="red")
shapiro.test(df$charges)
#Log normal check
hist(log(df$charges), freq=F, main="charges")
curve(dnorm(x,mean(x),sd(x)),lwd=2,add=T,col="red")
shapiro.test(log(df$charges))
# Chunk 12
# autocorrelation
acf(df$charges)
# Durbin-Watson Test for serial correlation
dwtest(df$charge ~ 1)
# Chunk 13
cor(df[c(7,1,3,4)])
pairs.panels(df[c(7,1,3,4)])
plot(df[c(7,1,3,4)])
# Chunk 14
res.con <- condes( df, num.var=7, proba = 0.01 )
res.con$quanti
res.con$quali
res.con$category
# Chunk 15
#First we check if there is any likely relation with any variable
par( mfrow = c(2,2))
plot(df$charges ~ df$age)
plot(df$charges ~ df$bmi)
plot(df$charges ~ df$children)
par( mfrow = c(1,1))
#It seems that with age there might be and slight cuadratic relation
m0a1 <- lm(charges ~ age, data = df)
summary(m0a1)
plot(df$charges ~ df$age)
lines(df$age, fitted(m0a1), lty = 2,col="red")
m0a2 <- lm(charges ~ age+ I(age^2), data = df)
summary(m0a2)
lines(df$age, fitted(m0a2), lty = 2,col="darkgreen")
m0a3 <- lm(charges ~ I(age^2), data = df)
summary(m0a3)
lines(df$age, fitted(m0a3), lty = 2,col="pink")
AIC(m0a1,m0a2,m0a3)
#Seems that using a polinomic aproach in age it would work better
#Now we check with bmi
m0b <- lm(charges ~ bmi, data = df)
summary(m0b)
plot(df$charges ~ df$bmi)
lines(df$bmi, fitted(m0b), lty = 2,col="red")
#there seems to not be a pattern
#Now we check with children
m0c <- lm(charges ~ children, data = df)
summary(m0c)
plot(df$charges ~ df$children)
lines(df$children, fitted(m0c), lty = 2,col="red")
#there seems to not be a pattern
# Chunk 16
#Now we try all the numeric values
m0 <- lm(charges ~ age + bmi + children , data = df)
summary(m0)
#The intercept is difficult to interpret because it is impossible to have 0's for all values
par( mfrow = c(2,2))
plot(m0, id.n = 0)
par( mfrow = c(1,1))
#Variance inflation factor
vif(m0)
boxcox( charges ~ age + bmi + children , data=df) #lambda = 0
boxTidwell( charges ~ age + bmi + I(children+0.5) , data=df) #lambda age = 1.8
boxTidwell( log(charges) ~ age + bmi + I(children+0.5) , data=df) #lambda age = 0.5
# First we will try the polinomic convertion with age
m1 <- lm(log(charges) ~ age + I(age^2) + bmi + I(children+0.5) , data = df)
summary(m1) # R2 = 0.3081
m2 <- lm(log(charges) ~  I(age^2) + bmi + I(children+0.5) , data = df)
summary(m2) #R2 = 0.2946
anova(m2,m1) # both models are not equivalent
AIC(m1,m2) #m1 has the best AIC (3048.388)
summary(m1)$r.squared
#So until now we keep m1, that has R2 =  0.3081237
# Chunk 17
residualPlots( m1, id=list(n=5, labels=rownames(df)))
marginalModelPlots(m1, id=list(n=5, labels=rownames(df)))
#Potentially influent data
#we use 2 because it is a small dataset
llev <- which( hatvalues(m1) > 2*(length(coef(m1))/nrow(df)));llev
m2 <- lm(log(charges) ~  age + I(age^2) + bmi + I(children+0.5) , data = df[-llev,])
summary(m2) # R2 = 0.3047
residualPlots(m2)
marginalModelPlots(m2, id=list(n=5, labels=rownames(df)))
# Chunk 18
# Threshold Chatterjee-Hadi
thChH <- 4/ (nrow(df) - length(coef(m2)));thChH
par(mfrow=c(1,1))
influencePlot(m2)
#All the cook distances from the values of the plot are small, comparing with thChH
#Actual influent data Cook´s distance: outliers in cook´s distance
Boxplot(cooks.distance(m2))
abline(h=thChH,col="red",lwd=3)
resout <- which( cooks.distance(m2) > thChH);resout
length(resout)
infres <- as.integer(c(llev,resout))
infres <- sort(infres[!duplicated(infres)]); infres
length(infres)
# BORRAR?
m3 <- lm(log(charges) ~  age + I(age^2) + bmi + I(children+0.5) , data = df[-infres,])
summary(m3) # R2 = 0.4556
# R2 =  0.3157
# 0.3049
residualPlots( m3)
marginalModelPlots(m3, id=list(n=5, labels=rownames(df)))
length(df[,1])
length(df[-infres,1])
# Chunk 19
# Chunk 20
names(df)
m6 <- lm(log(charges) ~  age +I(age^2) + bmi + I(children+0.5) + sex + smoker + region, data = df[-infres,])
summary(m6)
length(df[,1])
length(df[-infres,1])
m4 <- lm(log(charges) ~  I(age^2) + bmi + I(children+0.5) , data = df[-llev,])
summary(m4) # R2 = 0.3047
length(llev)
2*(length(coef(m1))/nrow(df))
2*(length(coef(m2))/nrow(df))
m1 <- lm(log(charges) ~ age + I(age^2) + bmi + I(children+0.5) , data = df)
summary(m1) # R2 = 0.3081
m2 <- lm(log(charges) ~  I(age^2) + bmi + I(children+0.5) , data = df)
2*(length(coef(m1))/nrow(df))
2*(length(coef(m2))/nrow(df))
length(llev)
llev <- which( hatvalues(m1) > 2*(length(coef(m2))/nrow(df)));llev
length(llev)
m4 <- lm(log(charges) ~  I(age^2) + bmi + I(children+0.5) , data = df[-llev,])
summary(m4) # R2 = 0.3047
summary(m1) # R2 = 0.3081
m2 <- lm(log(charges) ~  I(age^2) + bmi + I(children+0.5) , data = df)
summary(m2) #R2 = 0.2946
anova(m2,m1) # both models are not equivalent
AIC(m1,m2) #m1 has the best AIC (3048.388)
summary(m1)$r.squared
residualPlots( m1, id=list(n=5, labels=rownames(df)))
marginalModelPlots(m1, id=list(n=5, labels=rownames(df)))
#we use 2 because it is a small dataset
llev <- which( hatvalues(m1) > 2*(length(coef(m1))/nrow(df)));llev
length(llev)
m3 <- lm(log(charges) ~  age + I(age^2) + bmi + I(children+0.5) , data = df[-llev,])
summary(m3) # R2 = 0.3047
residualPlots(m3)
marginalModelPlots(m3, id=list(n=5, labels=rownames(df)))
length(coef(m1)
)
length(coef(m1))
length(coef(m3))
length(coef(m2))
# Threshold Chatterjee-Hadi
thChH <- 4/ (nrow(df) - length(coef(m3)));thChH
influencePlot(m3)
#Actual influent data Cook´s distance: outliers in cook´s distance
Boxplot(cooks.distance(m3))
abline(h=thChH,col="red",lwd=3)
resout <- which( cooks.distance(m3) > thChH);resout
length(resout)
infres <- as.integer(c(llev,resout))
infres <- sort(infres[!duplicated(infres)]); infres
length(infres)
# BORRAR?
m4 <- lm(log(charges) ~  age + I(age^2) + bmi + I(children+0.5) , data = df[-infres,])
summary(m4) # R2 = 0.3049
residualPlots( m4)
marginalModelPlots(m3, id=list(n=5, labels=rownames(df)))
marginalModelPlots(m4, id=list(n=5, labels=rownames(df)))
length(df[,1])
length(df[-infres,1])
m5 <- lm(log(charges) ~  age +I(age^2) + bmi + I(children+0.5) + sex + smoker + region, data = df[-infres,])
summary(m5)
m5 <- lm(log(charges) ~  age +I(age^2) + bmi + I(children+0.5) + sex + smoker + region, data = df[-llev,])
summary(m5)
m5 <- lm(log(charges) ~  age +I(age^2) + bmi + I(children+0.5) + sex + smoker + region, data = df[-resout,])
summary(m5)
m5 <- lm(log(charges) ~  age +I(age^2) + bmi + I(children+0.5) + sex + smoker + region, data = df[-llev,])
summary(m5)
Anova(m5)
Anova(m5)
#all variables are important
m6 <- step( m5)
summary(m6)
