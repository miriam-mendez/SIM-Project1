---
title: "SIM - Assignment 1"
author: "Míriam Méndez, Gabriel Zarate"
date: \today
output: pdf_document
subtitle: "Medical cost"
editor_options: 
  chunk_output_type: console
---

*Loading Libraries*

```{r}
# Load Required Packages: to be increased over the course

requiredPackages <- c("missMDA","effects","FactoMineR","car","factoextra","RColorBrewer","ggplot2","dplyr","ggmap","ggthemes","knitr","chemometrics","rpart","ROCR","corrr","readxl","RColorBrewer","psych","corrplot","plotly","xlsx","reshape2","scales","stargazer","kableExtra")

package.check <- lapply(requiredPackages, FUN = function(x) {
  if (!require(x, character.only = TRUE)) {
    install.packages(x, dependencies = TRUE)
    library(x, character.only = TRUE)
  }
})
```

*Reading Data*

```{r}
df <- read.csv("insurance.csv")
summary(df)

View(df)
```

# Data Preparation

## Remove duplicates

```{r}
df[duplicated(df), ]
nrow(df)

df <- df[!duplicated(df), ]
nrow(df)
```

## Fixing Structural Errors

```{r}

```

## Check Data Types

```{r}
lapply(df, class)
categ_cols <- c( 'sex', 'smoker', 'region')
df[categ_cols] = lapply(df[categ_cols], FUN = as.factor)
lapply(df, class)

```

Univariate Outliers

```{r}
par(mfrow=c(1,2))

Boxplot(df[,c(1,3,4)])
#Age no outliers
#Children no outliers

Boxplot(df$bmi)
Boxplot(df$charges)
#bmi and charges seem to have outliers

#Checking outliers for bmi

ss<-summary(df$bmi);ss
# Upper/lower severe threshold
utso2<-ss[5]+3*(ss[5]-ss[2]);utso2
utsi2<-ss[2]-3*(ss[5]-ss[2]);utsi2
# Upper/lower mild threshold
utmo2<-ss[5]+1.5*(ss[5]-ss[2]);utmo2
utmi2<-ss[2]-1.5*(ss[5]-ss[2]);utmi2

Boxplot(df$bmi,id=list(n=Inf,labels=row.names(df)))
Boxplot(df$bmi)
abline(h=utso2,col="red",lwd=3)
abline(h=utsi2,col="red",lwd=3)
abline(h=utmo2,col="green",lwd=3)
abline(h=utmi2,col="green",lwd=3)

lls<-which((df$bmi>utso2)|(df$bmi<utsi2));lls
df[lls,]
llm<-which((df$bmi>utmo2)|(df$bmi<utmi2));llm
df[llm,]

par(mfrow=c(1,1))

#Checking outliers for charges

ss<-summary(df$charges);ss
# Upper/lower severe threshold
utso2<-ss[5]+3*(ss[5]-ss[2]);utso2
utsi2<-ss[2]-3*(ss[5]-ss[2]);utsi2
# Upper/lower mild threshold
utmo2<-ss[5]+1.5*(ss[5]-ss[2]);utmo2
utmi2<-ss[2]-1.5*(ss[5]-ss[2]);utmi2

Boxplot(df$charges,id=list(n=Inf,labels=row.names(df)))
Boxplot(df$charges)
abline(h=utso2,col="red",lwd=3)
abline(h=utsi2,col="red",lwd=3)
abline(h=utmo2,col="green",lwd=3)
abline(h=utmi2,col="green",lwd=3)

lls<-which((df$charges>utso2)|(df$charges<utsi2));lls
df[lls,]
llm<-which((df$charges>utmo2)|(df$charges<utmi2));llm
df[llm,]

par(mfrow=c(1,1))

#Setting severe outliers from charges as NA

df[lls,"charges"]<-NA

summary(df$charges)
```

Check missing data

```{r}
mis_col = colSums(is.na(df))
mis_col

#Only charges has missing data (outliers)
imres<-imputePCA(df[c(1,3,4,7)])
names(imres)

#Imputated Data Validation
imres$completeObs[lls,"charges"]
par(mfrow=c(1,2))
Boxplot(imres$completeObs[,"charges"])
Boxplot(df$charges)

df[lls,"charges"]<-imres$completeObs[lls,"charges"]

```

Multivariate Outliers

```{r}
library(chemometrics)
res.mout <- Moutlier( df[ , c(1,3,4,7)], quantile = 0.999 )

par(mfrow=c(1,1))
plot( res.mout$md, res.mout$rd )
abline( h=res.mout$cutoff, lwd=2, col="red")
abline( v=res.mout$cutoff, lwd=2, col="red")

llmout <- which( ( res.mout$md > res.mout$cutoff ) & (res.mout$rd > res.mout$cutoff) );llmout
df[llmout,]
res.mout$md[llmout]

#Since there is only one multivariate outlier, we delete it
df <- df[-llmout,]

```

Data Validation

```{r}
summary(df)

#Checking bmi mild outliers
df[c(117,287,402,544,847,860,1087,1316),]

#There are two cases we have decided to delete because they aren't common, they are on the obbessity type IV, and have a really low age

df <- df[-c(847,1316),]

```

# Second part

## Create factors for qualitative variables [Done]

```{r}
summary(df)

```

## Determine if the response variable (charges) has an acceptably normal distribution

The distribution of charges is right-skewed. We can confirm this visually using a histogram:

```{r}
hist(df$charges)
```

It does not have an acceptable normal distribution. Most of the individuals spend between \$0 and \$15,000 on health insurance, although the tail of the distribution extends far these peaks.

## Address test to discard serial correlation ?

```{r}
# correlation matrix
cor(df[c(1,3,4,7)])

# autocorrelation
acf(df$charges)

# Durbin-Watson Test for serial correlation
dwtest(df$charge ~ 1)

```

Non of the correlations in the matrix are considered strong, whereas all have a positive correlation, meaning that as *feature 1* increase, *feature 2* also increase.

The autocorrelation is significantly different from zero at 5% level and we can see that there are periods of low and high variance.

## Detect univariant and multivariant outliers [Done]

## Preliminary exploratory analysis

```{r}
pairs.panels(df[c(1,3,4,7)])
```

In these scatter plots we have found interesting relationships between:

-   *age* and *charges* : displays several relatively straight lines.

-   *bmi* and *charges*: has two distinct groups of points.

-   
